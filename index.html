<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SendMo - Ship it, trust it</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/parse-address@1.0.0/parse-address.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0A0E27;
            --primary-light: #1A1F3A;
            --accent: #00E5CC;
            --accent-dark: #00B8A3;
            --text: #E8EAED;
            --text-muted: #9BA3AF;
            --surface: #14192D;
            --border: #2A3144;
            --error: #FF6B6B;
            --success: #51CF66;
        }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--primary);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            background: var(--primary);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(10, 14, 39, 0.9);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: -0.02em;
        }

        .tagline {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: -0.25rem;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 4rem 2rem;
            border-bottom: 1px solid var(--border);
        }

        .hero-content {
            max-width: 900px;
            margin: 0 auto;
            text-align: center;
        }

        .hero-title {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1.1;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-subtitle {
            font-size: 1.25rem;
            color: var(--text-muted);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .hero-illustration {
            margin: 3rem 0;
            padding: 2rem;
            background: var(--surface);
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        /* How It Works */
        .how-it-works {
            padding: 4rem 2rem;
            background: var(--primary);
        }

        .how-it-works-content {
            max-width: 1000px;
            margin: 0 auto;
        }

        .how-it-works-title {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 3rem;
        }

        .steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .step {
            background: var(--surface);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .step:hover {
            border-color: var(--accent);
            transform: translateY(-4px);
        }

        .step-number {
            display: inline-block;
            width: 40px;
            height: 40px;
            background: var(--accent);
            color: var(--primary);
            border-radius: 50%;
            font-weight: 700;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .step-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text);
        }

        .step-description {
            color: var(--text-muted);
            line-height: 1.6;
        }

        .step-emoji {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        /* CTA */
        .cta-button {
            display: inline-block;
            background: var(--accent);
            color: var(--primary);
            padding: 1rem 2.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1rem;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            margin: 0 auto;
            display: block;
            width: fit-content;
        }

        .cta-button:hover {
            background: var(--accent-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 229, 204, 0.3);
        }

        /* Main Content */
        .main {
            flex: 1;
            padding: 3rem 1.5rem;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Mock badge */
        .mock-badge {
            background: rgba(0, 229, 204, 0.1);
            color: var(--accent);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            text-align: center;
            margin-bottom: 2rem;
            border: 1px solid rgba(0, 229, 204, 0.2);
        }

        /* Card */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            margin-bottom: 2rem;
        }

        .card-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .card-description {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
            font-size: 0.95rem;
        }

        .input, .textarea {
            width: 100%;
            padding: 0.875rem;
            background: var(--primary-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        .input:focus, .textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 229, 204, 0.1);
        }

        .textarea {
            resize: vertical;
            min-height: 80px;
            font-family: 'Space Mono', monospace;
        }

        /* Size selector */
        .size-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .size-option {
            padding: 1rem;
            background: var(--primary-light);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .size-option:hover {
            border-color: var(--accent);
            background: rgba(0, 229, 204, 0.05);
        }

        .size-option.active {
            border-color: var(--accent);
            background: rgba(0, 229, 204, 0.1);
        }

        .size-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text);
        }

        .size-dims {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Shipping summary */
        .shipping-summary {
            background: var(--primary-light);
            padding: 1.25rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
        }

        .summary-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .summary-value {
            color: var(--text);
            font-weight: 500;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--primary);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Success view */
        .success-container {
            text-align: center;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: var(--accent);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0 auto 1.5rem;
        }

        .share-link {
            background: var(--primary-light);
            padding: 1rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            word-break: break-all;
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            color: var(--accent);
        }

        /* Footer */
        .footer {
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.875rem;
            border-top: 1px solid var(--border);
            margin-top: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2rem;
            }
            
            .hero-subtitle {
                font-size: 1rem;
            }

            .steps {
                grid-template-columns: 1fr;
            }

            .size-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Backend API base URL
        const API_BASE_URL = 'https://sendmo-backend.vercel.app';

        const PACKAGE_SIZES = [
            { 
                id: 'small', 
                label: 'Small', 
                dims: '6Ã—4Ã—2"',
                length: 6,
                width: 4,
                height: 2,
                weight: 8
            },
            { 
                id: 'medium', 
                label: 'Medium', 
                dims: '12Ã—9Ã—6"',
                length: 12,
                width: 9,
                height: 6,
                weight: 16
            },
            { 
                id: 'large', 
                label: 'Large', 
                dims: '18Ã—12Ã—10"',
                length: 18,
                width: 12,
                height: 10,
                weight: 32
            }
        ];

        async function createEasyPostShipment(fromAddress, toAddress, parcel) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/shipments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        from_address: fromAddress,
                        to_address: toAddress,
                        parcel: parcel
                    })
                });

                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    const apiMessage = err.error?.message || '';

                    // Translate API errors to user-friendly messages
                    if (response.status === 400) {
                        if (apiMessage.toLowerCase().includes('address')) {
                            throw new Error('The address could not be verified. Please check the street, city, state, and ZIP code are correct.');
                        }
                        if (apiMessage.toLowerCase().includes('zip') || apiMessage.toLowerCase().includes('postal')) {
                            throw new Error('Invalid ZIP code. Please enter a valid 5-digit US ZIP code.');
                        }
                        throw new Error('Invalid shipping information. Please check all fields and try again.');
                    }
                    if (response.status === 401 || response.status === 403) {
                        throw new Error('Service temporarily unavailable. Please try again later.');
                    }
                    if (response.status >= 500) {
                        throw new Error('Our shipping service is experiencing issues. Please try again in a few minutes.');
                    }
                    throw new Error(apiMessage || 'Unable to get shipping rates. Please verify your address and try again.');
                }

                return await response.json();
            } catch (error) {
                console.error('Shipment API error:', error);
                // Handle network errors
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error('Unable to connect to shipping service. Please check your internet connection.');
                }
                throw error;
            }
        }

        async function buyShipment(shipmentId, rateId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/shipments/${shipmentId}/buy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rate_id: rateId })
                });

                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    const apiMessage = err.error?.message || '';

                    if (response.status === 400) {
                        throw new Error('Unable to purchase this shipping label. The rate may have expired. Please refresh and try again.');
                    }
                    if (response.status >= 500) {
                        throw new Error('Our shipping service is experiencing issues. Please try again in a few minutes.');
                    }
                    throw new Error(apiMessage || 'Unable to purchase shipping label. Please try again.');
                }

                return await response.json();
            } catch (error) {
                console.error('Shipment buy error:', error);
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error('Unable to connect to shipping service. Please check your internet connection.');
                }
                throw error;
            }
        }

        async function verifyAddress(address) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/address/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(address)
                });

                if (!response.ok) {
                    return { valid: false, corrected: address, suggestions: [], errors: ['Could not verify address'] };
                }

                return await response.json();
            } catch (error) {
                console.error('Address verification error:', error);
                // On network error, just return the address as-is (don't block the flow)
                return { valid: true, corrected: address, suggestions: [], errors: [] };
            }
        }

        function LandingPage({ onGetStarted }) {
            return (
                <div className="app">
                    <header className="header">
                        <div className="header-content">
                            <div>
                                <div className="logo">SendMo</div>
                                <div className="tagline">ship it, trust it</div>
                            </div>
                        </div>
                    </header>

                    <section className="hero">
                        <div className="hero-content">
                            <h1 className="hero-title">
                                Ship anything safely on Facebook Marketplace
                            </h1>
                            <p className="hero-subtitle">
                                Create prepaid shipping labels for your online sales. No more sketchy meetups, 
                                complicated payment apps, or shipping hassles. Just click, ship, done.
                            </p>
                            
                            <div className="hero-illustration">
                                <svg width="100%" height="200" viewBox="0 0 600 200" style={{maxWidth: '600px', margin: '0 auto', display: 'block'}}>
                                    {/* Person 1 (Receiver) */}
                                    <circle cx="100" cy="100" r="30" fill="#00E5CC" opacity="0.2"/>
                                    <circle cx="100" cy="90" r="20" fill="#00E5CC"/>
                                    <text x="100" y="97" textAnchor="middle" fill="#0A0E27" fontSize="20">ðŸ‘¤</text>
                                    <text x="100" y="150" textAnchor="middle" fill="#9BA3AF" fontSize="14">You (Receiver)</text>
                                    
                                    {/* Arrow 1 */}
                                    <path d="M 130 100 L 220 100" stroke="#00E5CC" strokeWidth="2" fill="none" markerEnd="url(#arrowhead)"/>
                                    <text x="175" y="90" textAnchor="middle" fill="#00E5CC" fontSize="12">Creates label</text>
                                    
                                    {/* Box (Label) */}
                                    <rect x="240" y="75" width="50" height="50" fill="#14192D" stroke="#00E5CC" strokeWidth="2" rx="4"/>
                                    <text x="265" y="105" textAnchor="middle" fill="#00E5CC" fontSize="24">ðŸ“¦</text>
                                    <text x="265" y="150" textAnchor="middle" fill="#9BA3AF" fontSize="14">Shipping Label</text>
                                    
                                    {/* Arrow 2 */}
                                    <path d="M 310 100 L 400 100" stroke="#00E5CC" strokeWidth="2" fill="none" markerEnd="url(#arrowhead)"/>
                                    <text x="355" y="90" textAnchor="middle" fill="#00E5CC" fontSize="12">Shares link</text>
                                    
                                    {/* Person 2 (Sender) */}
                                    <circle cx="500" cy="100" r="30" fill="#00E5CC" opacity="0.2"/>
                                    <circle cx="500" cy="90" r="20" fill="#00E5CC"/>
                                    <text x="500" y="97" textAnchor="middle" fill="#0A0E27" fontSize="20">ðŸ‘¤</text>
                                    <text x="500" y="150" textAnchor="middle" fill="#9BA3AF" fontSize="14">Seller (Sender)</text>
                                    
                                    <defs>
                                        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                            <polygon points="0 0, 10 3, 0 6" fill="#00E5CC"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>

                            <button className="cta-button" onClick={onGetStarted}>
                                Create Your First Label
                            </button>
                        </div>
                    </section>

                    <section className="how-it-works">
                        <div className="how-it-works-content">
                            <h2 className="how-it-works-title">How It Works</h2>
                            
                            <div className="steps">
                                <div className="step">
                                    <div className="step-emoji">ðŸ“‹</div>
                                    <div className="step-number">1</div>
                                    <h3 className="step-title">You create the label</h3>
                                    <p className="step-description">
                                        Enter what you're receiving and where it's going. 
                                        We'll get real shipping rates from USPS, UPS, and FedEx.
                                    </p>
                                </div>
                                
                                <div className="step">
                                    <div className="step-emoji">ðŸ”—</div>
                                    <div className="step-number">2</div>
                                    <h3 className="step-title">Share the link</h3>
                                    <p className="step-description">
                                        Send the label link to your seller via text, email, or Facebook Messenger. 
                                        No apps to download, no accounts needed.
                                    </p>
                                </div>
                                
                                <div className="step">
                                    <div className="step-emoji">ðŸ“¦</div>
                                    <div className="step-number">3</div>
                                    <h3 className="step-title">They ship it</h3>
                                    <p className="step-description">
                                        Seller clicks the link, prints the prepaid label, and drops it at USPS/UPS. 
                                        You get tracking automatically.
                                    </p>
                                </div>
                            </div>

                            <div style={{textAlign: 'center', color: 'var(--text-muted)', marginTop: '2rem'}}>
                                <p><strong>No more:</strong> Meeting strangers in parking lots Â· Venmo requests Â· "I'll ship it tomorrow" excuses</p>
                                <p style={{marginTop: '0.5rem'}}><strong>Just:</strong> Click, ship, track, done. âœ¨</p>
                            </div>
                        </div>
                    </section>

                    <footer className="footer">
                        SendMo Â© 2026 Â· Ship safely
                    </footer>
                </div>
            );
        }

        function App() {
            const [showLanding, setShowLanding] = useState(true);
            const [view, setView] = useState('buyer');
            const [formData, setFormData] = useState({
                itemDescription: '',
                destinationAddress: '',
                destinationCity: '',
                destinationState: '',
                destinationZip: '',
                originAddress: '',
                originCity: '',
                originState: '',
                originZip: '',
                packageSize: 'medium'
            });
            const [shareLink, setShareLink] = useState('');
            const [rates, setRates] = useState([]);
            const [selectedRate, setSelectedRate] = useState(null);
            const [loading, setLoading] = useState(false);
            const [addressSuggestion, setAddressSuggestion] = useState(null); // { original, corrected, suggestions }
            const [error, setError] = useState('');
            const [shipmentData, setShipmentData] = useState(null);

            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const data = urlParams.get('data');
                if (data) {
                    try {
                        const decoded = JSON.parse(atob(data));
                        setFormData(prev => ({
                            ...prev,
                            destinationAddress: decoded.dest || '',
                            itemDescription: decoded.item || '',
                            packageSize: decoded.size || 'medium'
                        }));
                        setShowLanding(false);
                        setView('seller');
                    } catch (e) {
                        console.error('Failed to decode share link data:', e);
                    }
                } else if (urlParams.get('id')) {
                    // Legacy fallback
                    setShowLanding(false);
                    setView('seller');
                }
            }, []);

            const parseAddress = (addressString) => {
                if (!addressString || !addressString.trim()) {
                    return { street: '', city: '', state: '', zip: '' };
                }

                const text = addressString.trim();
                // Normalize multi-line to single line for parse-address
                const singleLine = text.replace(/\n+/g, ', ').replace(/,\s*,/g, ',');

                let street = '';
                let city = '';
                let state = '';
                let zip = '';

                // Try parse-address library first (if available)
                if (typeof parseAddress !== 'undefined' && window.parseAddress && window.parseAddress.parseLocation) {
                    try {
                        const parsed = window.parseAddress.parseLocation(singleLine);
                        if (parsed) {
                            // Build street from components
                            const streetParts = [
                                parsed.number,
                                parsed.prefix,
                                parsed.street,
                                parsed.type,
                                parsed.suffix,
                                parsed.sec_unit_type,
                                parsed.sec_unit_num
                            ].filter(Boolean);
                            street = streetParts.join(' ');
                            city = parsed.city || '';
                            state = parsed.state || '';
                            zip = parsed.zip || '';

                            // If parse-address got good results, use them
                            if (street && (zip || (city && state))) {
                                return {
                                    street: street,
                                    city: city || 'Unknown',
                                    state: state || '',
                                    zip: zip || ''
                                };
                            }
                        }
                    } catch (e) {
                        console.warn('parse-address failed, using fallback:', e);
                    }
                }

                // Fallback: custom parsing logic
                const US_STATES = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY','DC'];

                // Extract ZIP code
                const zipMatch = text.match(/\b(\d{5}(?:-\d{4})?)\b/);
                zip = zipMatch ? zipMatch[1] : '';

                // Extract state
                const stateBeforeZip = text.match(/\b([A-Z]{2})\s*\d{5}/i);
                if (stateBeforeZip && US_STATES.includes(stateBeforeZip[1].toUpperCase())) {
                    state = stateBeforeZip[1].toUpperCase();
                }
                if (!state) {
                    for (const st of US_STATES) {
                        if (new RegExp(`\\b${st}\\b`, 'i').test(text)) {
                            state = st;
                            break;
                        }
                    }
                }

                // Parse street and city
                const lines = text.split('\n').map(l => l.trim()).filter(l => l);

                if (lines.length >= 2) {
                    street = lines[0];
                    city = lines[lines.length - 1]
                        .replace(/\b\d{5}(-\d{4})?\b/g, '')
                        .replace(new RegExp(`\\b${state}\\b`, 'i'), '')
                        .replace(/,/g, '')
                        .trim();
                } else {
                    const parts = text.split(',').map(s => s.trim());
                    if (parts.length >= 2) {
                        street = parts[0];
                        city = (parts.length >= 3 ? parts[1] : parts[1])
                            .replace(/\b\d{5}(-\d{4})?\b/g, '')
                            .replace(new RegExp(`\\b${state}\\b`, 'i'), '')
                            .trim();
                    } else {
                        // No commas - extract street before city/state/zip
                        const noZip = text.replace(/\b\d{5}(-\d{4})?\b/g, '').trim();
                        const noState = state ? noZip.replace(new RegExp(`\\b${state}\\b`, 'i'), '').trim() : noZip;
                        const streetSuffixes = ['st', 'street', 'ave', 'avenue', 'rd', 'road', 'blvd', 'boulevard', 'dr', 'drive', 'ln', 'lane', 'way', 'ct', 'court', 'pl', 'place', 'cir', 'circle', 'pkwy', 'parkway', 'hwy', 'highway', 'nw', 'ne', 'sw', 'se', 'n', 's', 'e', 'w'];

                        const words = noState.split(/\s+/);
                        if (words.length >= 2) {
                            let cityStartIndex = words.length - 1;
                            while (cityStartIndex > 0 && streetSuffixes.includes(words[cityStartIndex].toLowerCase())) {
                                cityStartIndex--;
                            }
                            if (cityStartIndex > 0) {
                                const potentialCity = words[cityStartIndex];
                                const wordBefore = words[cityStartIndex - 1];
                                if (cityStartIndex > 1 && /^[A-Z]/.test(wordBefore) && !streetSuffixes.includes(wordBefore.toLowerCase())) {
                                    city = wordBefore + ' ' + potentialCity;
                                    street = words.slice(0, cityStartIndex - 1).join(' ');
                                } else {
                                    city = potentialCity;
                                    street = words.slice(0, cityStartIndex).join(' ');
                                }
                            } else {
                                street = noState;
                                city = 'Unknown';
                            }
                        } else {
                            street = noState;
                        }
                    }
                }

                return {
                    street: (street || '').replace(/,+$/, '').trim(),
                    city: city || 'Unknown',
                    state: state || '',
                    zip: zip || ''
                };
            };

            const handleInputChange = (e) => {
                setFormData({
                    ...formData,
                    [e.target.name]: e.target.value
                });
            };

            const handleSizeSelect = (sizeId) => {
                setFormData({
                    ...formData,
                    packageSize: sizeId
                });
            };

            const handleCreateLabel = async (useVerifiedAddress = null) => {
                setLoading(true);
                setError('');
                setAddressSuggestion(null);

                try {
                    const destAddr = parseAddress(formData.destinationAddress);

                    // Minimal validation - just need street OR zip to proceed
                    if (!destAddr.street && !destAddr.zip) {
                        throw new Error('Please enter at least a street address or ZIP code');
                    }

                    // Build address object for verification
                    let toAddress = useVerifiedAddress || {
                        street1: destAddr.street || '',
                        city: destAddr.city || '',
                        state: destAddr.state || '',
                        zip: destAddr.zip || '',
                        country: 'US'
                    };

                    // If not already verified, verify the address first
                    if (!useVerifiedAddress) {
                        const verification = await verifyAddress(toAddress);

                        // If there are corrections, show them to user for confirmation
                        if (verification.suggestions && verification.suggestions.length > 0) {
                            setAddressSuggestion({
                                original: toAddress,
                                corrected: verification.corrected,
                                suggestions: verification.suggestions
                            });
                            setLoading(false);
                            return; // Wait for user to confirm
                        }

                        // If there are errors and no valid address, show error
                        if (verification.errors && verification.errors.length > 0 && !verification.valid) {
                            throw new Error(verification.errors[0]);
                        }

                        // Use corrected address (may have filled in city/state from ZIP)
                        if (verification.corrected) {
                            toAddress = verification.corrected;
                        }
                    }

                    // Fill in any missing fields with defaults
                    if (!toAddress.city) toAddress.city = 'Unknown';
                    if (!toAddress.state) toAddress.state = 'CA';

                    const packageConfig = PACKAGE_SIZES.find(s => s.id === formData.packageSize);

                    const originCity = formData.originCity || 'San Francisco';
                    const fromAddress = {
                        street1: '123 Placeholder St',
                        city: originCity,
                        state: 'CA',
                        zip: '94102',
                        country: 'US'
                    };

                    const parcel = {
                        length: packageConfig.length,
                        width: packageConfig.width,
                        height: packageConfig.height,
                        weight: packageConfig.weight
                    };

                    const shipment = await createEasyPostShipment(fromAddress, toAddress, parcel);

                    if (!shipment.rates || shipment.rates.length === 0) {
                        throw new Error('No shipping rates available for this address');
                    }

                    setShipmentData(shipment);
                    setRates(shipment.rates);
                    setSelectedRate(shipment.rates[0]);

                    // Encode VERIFIED address into share link
                    const verifiedAddressStr = `${toAddress.street1}\n${toAddress.city}, ${toAddress.state} ${toAddress.zip}`;
                    const shipmentInfo = {
                        dest: verifiedAddressStr,
                        item: formData.itemDescription,
                        size: formData.packageSize
                    };
                    const encoded = btoa(JSON.stringify(shipmentInfo));
                    const link = `${window.location.origin}?data=${encoded}`;
                    setShareLink(link);
                    setView('success');

                } catch (err) {
                    setError(err.message || 'Failed to create shipping label. Please try again.');
                    console.error('Error creating label:', err);
                } finally {
                    setLoading(false);
                }
            };

            const handlePrintLabel = async (useVerifiedAddress = null) => {
                setLoading(true);
                setError('');
                setAddressSuggestion(null);

                try {
                    const originAddr = parseAddress(formData.originAddress);

                    // Minimal validation - just need street OR zip
                    if (!originAddr.street && !originAddr.zip) {
                        throw new Error('Please enter at least a street address or ZIP code');
                    }

                    // Build address for verification
                    let fromAddress = useVerifiedAddress || {
                        street1: originAddr.street || '',
                        city: originAddr.city || '',
                        state: originAddr.state || '',
                        zip: originAddr.zip || '',
                        country: 'US'
                    };

                    // If not already verified, verify the address
                    if (!useVerifiedAddress) {
                        const verification = await verifyAddress(fromAddress);

                        // If there are corrections, show them for confirmation
                        if (verification.suggestions && verification.suggestions.length > 0) {
                            setAddressSuggestion({
                                original: fromAddress,
                                corrected: verification.corrected,
                                suggestions: verification.suggestions,
                                isSeller: true // Flag to know which handler to call
                            });
                            setLoading(false);
                            return;
                        }

                        // Use corrected address if available
                        if (verification.corrected) {
                            fromAddress = verification.corrected;
                        }
                    }

                    // Fill in defaults
                    if (!fromAddress.city) fromAddress.city = 'Unknown';
                    if (!fromAddress.state) fromAddress.state = 'CA';

                    const packageConfig = PACKAGE_SIZES.find(s => s.id === formData.packageSize);

                    // Destination was already verified by buyer, just parse it
                    const destAddr = parseAddress(formData.destinationAddress);
                    const toAddress = {
                        street1: destAddr.street || '',
                        city: destAddr.city || 'Unknown',
                        state: destAddr.state || 'CA',
                        zip: destAddr.zip || '',
                        country: 'US'
                    };

                    const parcel = {
                        length: packageConfig.length,
                        width: packageConfig.width,
                        height: packageConfig.height,
                        weight: packageConfig.weight
                    };

                    const shipment = await createEasyPostShipment(fromAddress, toAddress, parcel);
                    
                    if (!shipment.rates || shipment.rates.length === 0) {
                        throw new Error('No shipping rates available');
                    }

                    const cheapestRate = shipment.rates[0];
                    const purchasedShipment = await buyShipment(shipment.id, cheapestRate.id);
                    
                    if (!purchasedShipment.postage_label) {
                        throw new Error('Failed to generate label');
                    }

                    setShipmentData(purchasedShipment);
                    window.open(purchasedShipment.postage_label.label_url, '_blank');
                    
                    setView('print');

                } catch (err) {
                    setError(err.message || 'Failed to generate label. Please try again.');
                    console.error('Error generating label:', err);
                } finally {
                    setLoading(false);
                }
            };

            const copyToClipboard = () => {
                navigator.clipboard.writeText(shareLink);
                alert('Link copied to clipboard!');
            };

            if (showLanding) {
                return <LandingPage onGetStarted={() => setShowLanding(false)} />;
            }

            return (
                <div className="app">
                    <header className="header">
                        <div className="header-content">
                            <div>
                                <div className="logo" style={{cursor: 'pointer'}} onClick={() => { setShowLanding(true); setView('buyer'); setError(''); }}>SendMo</div>
                                <div className="tagline">ship it, trust it</div>
                            </div>
                        </div>
                    </header>
                    <main className="main">
                        <div className="container">
                            <div className="mock-badge">
                                Demo Mode â€” Shipping rates are estimated
                            </div>

                            {error && (
                                <div style={{
                                    background: 'rgba(255, 107, 107, 0.1)',
                                    border: '1px solid var(--error)',
                                    color: 'var(--error)',
                                    padding: '1rem',
                                    borderRadius: '8px',
                                    marginBottom: '1.5rem',
                                    fontSize: '0.9rem'
                                }}>
                                    {error}
                                </div>
                            )}

                            {/* Address Correction Suggestion */}
                            {addressSuggestion && (
                                <div className="card" style={{marginBottom: '1.5rem', borderColor: 'var(--accent)'}}>
                                    <div className="card-header">
                                        <h2 className="card-title" style={{fontSize: '1.25rem'}}>Address Correction</h2>
                                        <p className="card-description">We found a better format for your address:</p>
                                    </div>

                                    <div style={{marginBottom: '1rem'}}>
                                        {addressSuggestion.suggestions.map((s, i) => (
                                            <div key={i} style={{
                                                padding: '0.5rem 0.75rem',
                                                background: 'rgba(0, 229, 204, 0.1)',
                                                borderRadius: '4px',
                                                marginBottom: '0.5rem',
                                                fontSize: '0.9rem',
                                                color: 'var(--accent)'
                                            }}>
                                                {s}
                                            </div>
                                        ))}
                                    </div>

                                    <div className="shipping-summary" style={{marginBottom: '1rem'}}>
                                        <div className="summary-row">
                                            <span className="summary-label">Corrected address</span>
                                        </div>
                                        <div style={{fontFamily: 'Space Mono', fontSize: '0.9rem', marginTop: '0.5rem'}}>
                                            {addressSuggestion.corrected.street1}<br/>
                                            {addressSuggestion.corrected.city}, {addressSuggestion.corrected.state} {addressSuggestion.corrected.zip}
                                        </div>
                                    </div>

                                    <div style={{display: 'flex', gap: '0.75rem'}}>
                                        <button
                                            className="btn btn-primary"
                                            style={{flex: 1}}
                                            onClick={() => addressSuggestion.isSeller
                                                ? handlePrintLabel(addressSuggestion.corrected)
                                                : handleCreateLabel(addressSuggestion.corrected)}
                                        >
                                            Use Corrected Address
                                        </button>
                                        <button
                                            className="btn btn-secondary"
                                            style={{flex: 1}}
                                            onClick={() => addressSuggestion.isSeller
                                                ? handlePrintLabel(addressSuggestion.original)
                                                : handleCreateLabel(addressSuggestion.original)}
                                        >
                                            Keep Original
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Buyer View â€” Create Label */}
                            {view === 'buyer' && (
                                <div className="card">
                                    <div className="card-header">
                                        <h2 className="card-title">Create a Shipping Label</h2>
                                        <p className="card-description">Enter what you're receiving and where it should be delivered.</p>
                                    </div>

                                    <div className="form-group">
                                        <label className="label">What are you receiving?</label>
                                        <input
                                            className="input"
                                            name="itemDescription"
                                            value={formData.itemDescription}
                                            onChange={handleInputChange}
                                            placeholder='e.g. "Vintage backpack from Facebook Marketplace"'
                                        />
                                    </div>

                                    <div className="form-group">
                                        <label className="label">Your address (destination)</label>
                                        <textarea
                                            className="textarea"
                                            name="destinationAddress"
                                            value={formData.destinationAddress}
                                            onChange={handleInputChange}
                                            placeholder={"123 Main St\nNew York, NY 10001"}
                                            rows={3}
                                        />
                                    </div>

                                    <div className="form-group">
                                        <label className="label">Seller's city (optional)</label>
                                        <input
                                            className="input"
                                            name="originCity"
                                            value={formData.originCity}
                                            onChange={handleInputChange}
                                            placeholder="e.g. Los Angeles"
                                        />
                                    </div>

                                    <div className="form-group">
                                        <label className="label">Estimated package size</label>
                                        <div className="size-grid">
                                            {PACKAGE_SIZES.map(size => (
                                                <div
                                                    key={size.id}
                                                    className={`size-option ${formData.packageSize === size.id ? 'active' : ''}`}
                                                    onClick={() => handleSizeSelect(size.id)}
                                                >
                                                    <span className="size-label">{size.label}</span>
                                                    <span className="size-dims">{size.dims}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <button
                                        className="btn btn-primary"
                                        onClick={handleCreateLabel}
                                        disabled={loading || !formData.itemDescription || !formData.destinationAddress}
                                    >
                                        {loading ? 'Creating Label...' : 'Create Shipping Label'}
                                    </button>
                                </div>
                            )}

                            {/* Seller View â€” Print Label */}
                            {view === 'seller' && (
                                <div className="card">
                                    <div className="card-header">
                                        <h2 className="card-title">Print & Ship</h2>
                                        <p className="card-description">A prepaid label has been created for you. Enter your address and print it.</p>
                                    </div>

                                    {formData.itemDescription && (
                                        <div className="shipping-summary" style={{marginBottom: '1.5rem'}}>
                                            <div className="summary-row">
                                                <span className="summary-label">Item</span>
                                                <span className="summary-value">{formData.itemDescription}</span>
                                            </div>
                                            {formData.destinationAddress && (
                                                <div className="summary-row">
                                                    <span className="summary-label">Shipping to</span>
                                                    <span className="summary-value">{formData.destinationAddress.split('\n').pop()}</span>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    <div className="form-group">
                                        <label className="label">Your address (origin)</label>
                                        <textarea
                                            className="textarea"
                                            name="originAddress"
                                            value={formData.originAddress}
                                            onChange={handleInputChange}
                                            placeholder={"456 Seller Ave\nLos Angeles, CA 90001"}
                                            rows={3}
                                        />
                                    </div>

                                    <div className="form-group">
                                        <label className="label">Confirm package size</label>
                                        <div className="size-grid">
                                            {PACKAGE_SIZES.map(size => (
                                                <div
                                                    key={size.id}
                                                    className={`size-option ${formData.packageSize === size.id ? 'active' : ''}`}
                                                    onClick={() => handleSizeSelect(size.id)}
                                                >
                                                    <span className="size-label">{size.label}</span>
                                                    <span className="size-dims">{size.dims}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <button
                                        className="btn btn-primary"
                                        onClick={handlePrintLabel}
                                        disabled={loading || !formData.originAddress}
                                    >
                                        {loading ? 'Generating Label...' : 'Print Shipping Label'}
                                    </button>
                                </div>
                            )}

                            {/* Success View â€” Share Link */}
                            {view === 'success' && (
                                <div className="card">
                                    <div className="success-container">
                                        <div className="success-icon">âœ“</div>
                                        <h2 className="card-title">Label Created!</h2>
                                        <p className="card-description" style={{marginBottom: '1.5rem'}}>
                                            Share this link with your seller so they can print the prepaid label.
                                        </p>

                                        <div className="share-link" onClick={copyToClipboard} style={{cursor: 'pointer'}}>
                                            {shareLink}
                                        </div>

                                        <button className="btn btn-primary" onClick={copyToClipboard} style={{marginBottom: '1rem'}}>
                                            Copy Link
                                        </button>

                                        {rates.length > 0 && (
                                            <div className="shipping-summary" style={{textAlign: 'left', marginTop: '1.5rem'}}>
                                                <h3 style={{marginBottom: '0.75rem', fontSize: '1rem'}}>Shipping Rates</h3>
                                                {rates.slice(0, 5).map((rate, i) => (
                                                    <div className="summary-row" key={rate.id || i}>
                                                        <span className="summary-label">{rate.carrier} {rate.service}</span>
                                                        <span className="summary-value">${(parseFloat(rate.rate)).toFixed(2)}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}

                                        <button className="btn btn-secondary" onClick={() => { setView('buyer'); setError(''); }} style={{marginTop: '1rem'}}>
                                            Create Another Label
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Print Confirmation View */}
                            {view === 'print' && (
                                <div className="card">
                                    <div className="success-container">
                                        <div className="success-icon">ðŸ“¦</div>
                                        <h2 className="card-title">Label Printed!</h2>
                                        <p className="card-description" style={{marginBottom: '1.5rem'}}>
                                            Attach the label to your package and drop it off at the carrier.
                                        </p>

                                        {shipmentData && shipmentData.tracking_code && (
                                            <div className="shipping-summary" style={{textAlign: 'left'}}>
                                                <div className="summary-row">
                                                    <span className="summary-label">Tracking Number</span>
                                                    <span className="summary-value">{shipmentData.tracking_code}</span>
                                                </div>
                                                {shipmentData.selected_rate && (
                                                    <>
                                                        <div className="summary-row">
                                                            <span className="summary-label">Carrier</span>
                                                            <span className="summary-value">{shipmentData.selected_rate.carrier} {shipmentData.selected_rate.service}</span>
                                                        </div>
                                                        <div className="summary-row">
                                                            <span className="summary-label">Cost</span>
                                                            <span className="summary-value">${shipmentData.selected_rate.rate}</span>
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        )}

                                        {shipmentData && shipmentData.postage_label && (
                                            <button
                                                className="btn btn-primary"
                                                onClick={() => window.open(shipmentData.postage_label.label_url, '_blank')}
                                                style={{marginBottom: '1rem'}}
                                            >
                                                Re-Download Label
                                            </button>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                    <footer className="footer">
                        SendMo Â© 2026 Â· Ship safely
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
